@using WalliCardsNet.ClassLibrary.Customer
@using WalliCardsNet.Client.Components.Customer

@page "/customers"
@inject WalliCardsApiService ApiService
@inject AuthStateProvider AuthStateProvider


<h3>Customer Overview</h3>

@if (Isloading == true && Columns.Count == 0)
{
    <p>Loading business settings</p>
}

@if (Isloading == true && Columns.Count > 0)
{
    <p>Loading customer data</p>
}

@if (Isloading == false && ErrorMessage == null)
{
    <EditTable Columns="Columns" OnColumnsUpdated="UpdateColumns" />

    <QuickGrid Items="Customers" Class="table">

        @foreach (var column in Columns)
        {
            if (column.IsSelected)
            {
                <PropertyColumn Title="@(column.Title)"
                                Property="@(c => c.CustomerDetails!.ContainsKey(column.Key) ? c.CustomerDetails[column.Key] : "-")"
                                Sortable="true" />
            }
        }

    </QuickGrid>
}
else
{
    @ErrorMessage
}


@code {
    public List<DataColumnDTO> Columns { get; set; } = [];   // Sätta upp Cascading Parameter?
    public IQueryable<CustomerResponseDTO> Customers { get; set; }
    public bool Isloading { get; set; } = true;
    public string? ErrorMessage { get; set; }


    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity.IsAuthenticated)
            {
                var businessIdClaim = user.FindFirst("business-id");

                if (businessIdClaim != null)
                {
                    var businessId = Guid.Parse(businessIdClaim.Value);
                    var businessResponse = await ApiService.GetByIdAsync<BusinessResponseDTO>("business", businessId);

                    if (businessResponse.IsSuccess)
                    {
                        var business = businessResponse.Data;
                        Columns = business.DataColumns;
                        StateHasChanged();
                    }

                    var customerResponse = await ApiService.GetAllAsync<List<CustomerResponseDTO>>("customer");

                    if (customerResponse.IsSuccess)
                    {
                        var data = customerResponse.Data;
                        Customers = data.AsQueryable();
                    }
                }
            }
        }
        catch (Exception)
        {
            ErrorMessage = "Failed to load customer data";
        }
        finally
        {
            Isloading = false;
        }
    }

    private void UpdateColumns(List<DataColumnDTO> updatedColumns)
    {
        Columns = updatedColumns;
        StateHasChanged();
    }
}
